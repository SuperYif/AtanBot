<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> <!-- 禁止用户缩放，保持固定比例 -->
    <title>ifBot.</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        /* 定义CSS变量，用于主题颜色的灵活控制 */
        :root {
            --bg-color: #ffffff;  /* 页面背景颜色 */
            --text-color: #333333; /* 文字颜色 */
            --chat-bg: #f0f0f0;    /* 聊天窗口背景颜色 */
            --user-msg-bg: #dcf8c6; /* 用户消息的背景颜色 */
            --ai-msg-bg: #e6e6e6;   /* AI 消息的背景颜色 */
            --input-bg: #ffffff;    /* 输入框背景颜色 */
            --button-bg: #075e54;   /* 发送按钮背景颜色（绿色） */
            --button-text: #ffffff; /* 按钮文字颜色 */
            --button-disabled-bg: #b0b0b0; /* 停止按钮背景颜色（灰色） */
        }

        /* 定义深色模式的颜色变量 */
        .dark-mode {
            --bg-color: #1e1e1e;    /* 深色模式下的页面背景颜色 */
            --text-color: #ffffff;  /* 深色模式下的文字颜色 */
            --chat-bg: #2c2c2c;     /* 深色模式下的聊天窗口背景颜色 */
            --user-msg-bg: #056162; /* 深色模式下的用户消息背景颜色 */
            --ai-msg-bg: #323232;   /* 深色模式下的 AI 消息背景颜色 */
            --input-bg: #3a3a3a;    /* 深色模式下的输入框背景颜色 */
            --button-bg: #128c7e;   /* 深色模式下的按钮背景颜色 */
            --button-text: #ffffff; /* 深色模式下的按钮文字颜色 */
            --button-disabled-bg: #555555; /* 深色模式下按钮禁用时的背景颜色 */
        }

        /* 全局 body 样式 */
        body {
            font-family: Arial, sans-serif;  /* 设定字体 */
            background-color: var(--bg-color);  /* 使用CSS变量设置背景颜色 */
            color: var(--text-color);  /* 使用CSS变量设置文字颜色 */
            max-width: 800px;  /* 页面内容的最大宽度 */
            margin: 0 auto;  /* 居中显示页面 */
            padding: 20px;  /* 内边距，控制内容与页面边缘的距离 */
            display: flex;
            flex-direction: column;  /* 使页面的内容从上到下排列 */
            height: 100dvh;  /* 使用动态视口高度，确保在移动设备上动态适应 */
            box-sizing: border-box;  /* 包括内边距和边框的计算 */
        }

        /* 聊天窗口的样式 */
        #chat-container {
            flex-grow: 1;  /* 确保聊天窗口占据页面的剩余空间 */
            overflow-y: auto;  /* 启用竖直滚动条 */
            padding: 10px;  /* 内边距，控制聊天内容与边缘的距离 */
            background-color: var(--chat-bg);  /* 使用CSS变量设置聊天窗口的背景颜色 */
            border-radius: 10px;  /* 设置圆角 */
            margin-bottom: 10px;  /* 控制聊天窗口与下方输入框的距离 */
            max-height: calc(100dvh - 100px);  /* 控制聊天窗口的最大高度，避免超出页面 */
            box-sizing: border-box;
        }

        /* 消息气泡的通用样式 */
        .message {
            margin-bottom: 10px;  /* 每条消息之间的间距 */
            padding: 10px;  /* 消息气泡的内边距 */
            border-radius: 10px;  /* 圆角边框 */
            max-width: 80%;  /* 消息气泡的最大宽度，相对于父容器 */
        }

        /* 用户消息样式，右对齐 */
        .user-message {
            background-color: var(--user-msg-bg);  /* 使用CSS变量设置用户消息的背景颜色 */
            align-self: flex-end;  /* 用户消息靠右对齐 */
            margin-left: auto;  /* 用户消息距离左侧自动对齐 */
        }

        /* AI 消息样式，左对齐 */
        .ai-message {
            background-color: var(--ai-msg-bg);  /* 使用CSS变量设置AI消息的背景颜色 */
            align-self: flex-start;  /* AI消息靠左对齐 */
        }

        /* 输入框和按钮的容器样式 */
        #input-container {
            display: flex;  /* 使输入框和发送按钮并排排列 */
            margin-top: 10px;  /* 控制输入框和发送按钮与上方聊天窗口的距离 */
            box-sizing: border-box;
        }

        /* 输入框样式 */
        #user-input {
            flex-grow: 1;  /* 输入框占据可用的水平空间 */
            padding: 10px;  /* 输入框的内边距 */
            border: none;  /* 移除边框 */
            border-radius: 20px;  /* 圆角边框 */
            background-color: var(--input-bg);  /* 使用CSS变量设置输入框背景颜色 */
            color: var(--text-color);  /* 使用CSS变量设置文字颜色 */
            box-sizing: border-box;
            min-height: 1.2em; /* 初始高度与字体大小一致 */
            max-height: 108px;  /* 最大扩展高度为三行 */
            overflow-y: auto;  /* 超出高度时启用滚动条 */
        }

        /* 发送按钮和停止按钮样式，保持一致，仅颜色不同 */
        #send-button {
            width: 100px;  /* 按钮的固定宽度 */
            height: 40px;  /* 按钮的固定高度 */
            padding: 10px 20px;  /* 按钮的内边距 */
            border: none;  /* 移除边框 */
            border-radius: 20px;  /* 圆角边框 */
            margin-left: 10px;  /* 输入框和发送按钮之间的距离 */
            cursor: pointer;  /* 鼠标悬停时显示指针 */
        }

        /* 发送按钮，绿色背景 */
        #send-button.send-mode {
            background-color: var(--button-bg);  /* 发送按钮背景颜色（绿色） */
            color: var(--button-text);  /* 按钮文字颜色 */
        }

        /* 停止按钮，灰色背景 */
        #send-button.stop-mode {
            background-color: var(--button-disabled-bg);  /* 停止按钮背景颜色（灰色） */
            color: var(--button-text);  /* 按钮文字颜色 */
        }

        /* 切换主题按钮样式 */
        #theme-toggle {
            position: absolute;  /* 绝对定位 */
            top: 20px;  /* 距离页面顶部20px */
            right: 20px;  /* 距离页面右侧20px */
            padding: 5px 10px;  /* 内边距 */
            border: none;  /* 移除边框 */
            border-radius: 5px;  /* 圆角边框 */
            background-color: var(--button-bg);  /* 使用CSS变量设置背景颜色 */
            color: var(--button-text);  /* 使用CSS变量设置文字颜色 */
            cursor: pointer;  /* 鼠标悬停时显示指针 */
        }
    </style>
</head>
<body>
    <!-- 主题切换按钮 -->
    <button id="theme-toggle" onclick="toggleTheme()">切换主题</button>
    
    <!-- 聊天内容容器 -->
    <div id="chat-container"></div>

    <!-- 输入框和发送按钮容器 -->
    <div id="input-container">
        <textarea id="user-input" rows="1" placeholder="输入您的问题..."></textarea>
        <button id="send-button" class="send-mode" onclick="sendMessage()">发送</button>  <!-- 初始状态为发送 -->
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');  /* 聊天窗口元素 */
        const userInput = document.getElementById('user-input');  /* 输入框元素 */
        const sendButton = document.getElementById('send-button');  /* 发送按钮元素 */
        const converter = new showdown.Converter();  /* Markdown 转换器 */
        const conversationHistory = [];  /* 用于存储对话的历史记录 */
        let stopGenerating = false;  /* 用于控制停止生成 */

        const modelAPIMapping = {
            "deepseek": {
                apiKey: "sk-92c88102bc1d432e99b3523e0dd2a169",  /* Deepseek API 的密钥 */
                apiUrl: "https://api.deepseek.com/chat/completions",  /* Deepseek API 的URL */
                model: "deepseek-chat"  /* 使用的模型名称 */
            }
        };

        /* 主题切换函数 */
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');  /* 切换深色模式 */
        }

        /* 发送消息函数 */
        async function sendMessage() {
            const userMessage = userInput.value.trim();  /* 获取并去除输入框内容的首尾空格 */
            if (userMessage === '') return;  /* 如果输入为空，则不发送 */

            stopGenerating = false;  /* 重置停止生成标志 */
            sendButton.textContent = '停止';  /* 将按钮文字设置为“停止” */
            sendButton.classList.remove('send-mode');  /* 移除发送按钮的绿色样式 */
            sendButton.classList.add('stop-mode');  /* 添加停止按钮的灰色样式 */
            sendButton.onclick = stopMessage;  /* 设置点击事件为停止生成 */

            conversationHistory.push({ role: 'user', content: userMessage });  /* 将用户消息加入历史记录 */
            appendMessage('用户', userMessage, 'user-message');  /* 在页面上显示用户消息 */
            userInput.value = '';  /* 清空输入框 */

            const aiMessageElement = appendMessage('AI', '', 'ai-message');  /* 创建一个空的AI消息元素 */
            let aiMessageContent = '';  /* 用于保存AI回复内容 */

            try {
                /* 调用Deepseek API */
                const response = await fetch(modelAPIMapping.deepseek.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${modelAPIMapping.deepseek.apiKey}`
                    },
                    body: JSON.stringify({
                        model: modelAPIMapping.deepseek.model,
                        messages: conversationHistory,
                        stream: true
                    })
                });

                const reader = response.body.getReader();  /* 创建流读取器 */
                const decoder = new TextDecoder();  /* 创建文本解码器 */

                while (true) {
                    if (stopGenerating) break;  /* 如果用户选择停止，跳出循环 */
                    const { done, value } = await reader.read();
                    if (done) break;  /* 如果流读取结束，退出循环 */

                    const chunk = decoder.decode(value);  /* 解码读取到的文本 */
                    const lines = chunk.split('\n');  /* 按行分割文本 */

                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            const jsonData = line.slice(5);  /* 获取数据部分 */
                            if (jsonData.trim() === '[DONE]') break;  /* 完成后退出 */

                            try {
                                const parsedData = JSON.parse(jsonData);  /* 解析JSON */
                                const content = parsedData.choices[0].delta.content;  /* 获取AI的回复内容 */
                                if (content) {
                                    aiMessageContent += content;  /* 累加回复内容 */
                                    aiMessageElement.innerHTML = `<strong>AI:</strong> ${formatMessage(aiMessageContent)}`;  /* 显示AI回复 */
                                    chatContainer.scrollTop = chatContainer.scrollHeight;  /* 滚动到聊天窗口底部 */
                                }
                            } catch (error) {
                                console.error('Error parsing JSON:', error);  /* 处理解析错误 */
                            }
                        }
                    }
                }

                conversationHistory.push({ role: 'assistant', content: aiMessageContent });  /* 将AI回复加入历史记录 */
            } catch (error) {
                console.error('Error:', error);  /* 处理请求错误 */
                appendMessage('系统', '发生错误，请稍后再试。', 'system-message');  /* 显示错误消息 */
            } finally {
                sendButton.textContent = '发送';  /* 按钮文字恢复为“发送” */
                sendButton.classList.remove('stop-mode');  /* 移除停止按钮的灰色样式 */
                sendButton.classList.add('send-mode');  /* 添加发送按钮的绿色样式 */
                sendButton.onclick = sendMessage;  /* 恢复点击事件为发送消息 */
                userInput.style.height = '36px';  /* 恢复输入框的高度 */
            }
        }

        /* 提前结束回复生成的函数 */
        function stopMessage() {
            stopGenerating = true;  /* 设置标志为停止 */
        }

        /* 在聊天窗口中追加消息 */
        function appendMessage(sender, message, className) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', className);  /* 添加样式类 */
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${formatMessage(message)}`;  /* 设置消息内容 */
            chatContainer.appendChild(messageDiv);  /* 将消息添加到聊天窗口 */
            chatContainer.scrollTop = chatContainer.scrollHeight;  /* 滚动到底部 */
            return messageDiv;
        }

        /* 将Markdown格式的消息转换为HTML */
        function formatMessage(message) {
            return converter.makeHtml(message);
        }

        /* 自动调整输入框高度，限制最大高度为三行 */
        userInput.addEventListener('input', function() {
            this.style.height = '36px';  /* 重置高度为一行 */
            if (this.scrollHeight <= 108) {
                this.style.height = this.scrollHeight + 'px';  /* 根据内容调整高度 */
            } else {
                this.style.height = '108px';  /* 限制最大高度为三行 */
            }
        });
    </script>
</body>
</html>
