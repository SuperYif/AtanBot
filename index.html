<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>增强型AI助手</title>
    <style>
        /* 设置整个网页的基础样式，包括字体、边距和高度 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #343541; /* 防止出现白边 */
        }

        /* 顶部栏样式，固定在页面顶部，覆盖整个宽度 */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #202123;
            color: white;
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 102;
            box-sizing: border-box;
        }

        /* 顶部栏内容容器，分左右两侧 */
        .top-bar-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        /* 顶部栏左侧部分样式 */
        .top-bar-left {
            display: flex;
            align-items: center;
            position: relative;
        }

        /* 顶部栏右侧部分可以将来放置更多内容或按钮 */
        .top-bar-right {
            display: flex;
            align-items: center;
        }

        /* 文字打字效果的样式 */
        #greeting {
            font-family: 'Courier New', Courier, monospace;
            white-space: nowrap;
            overflow: hidden;
            border-right: 3px solid white; /* 光标样式 */
            animation: caret-blink 0.7s step-end infinite;
        }

        @keyframes caret-blink {
            from, to { border-color: transparent; }
            50% { border-color: white; }
        }

        /* 调整展开/折叠按钮的样式和定位 */
        .toggle-btn {
            background-color: #343541; /* 使用与下层元素相近的颜色 */
            border: none;
            color: white;
            width: 40px; /* 设置宽度 */
            height: 40px; /* 设置高度 */
            cursor: pointer;
            border-radius: 20px; /* 圆角矩形 */
            margin-left: 10px; /* 按钮与“AI助手”之间的间距 */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 侧边栏的样式设置，包括宽度、背景色、字体颜色、内边距和布局 */
        .sidebar {
            width: 260px;
            background-color: #202123;
            color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: fixed;
            top: 50px; /* 调整顶部，留出顶部栏的高度 */
            left: 0;
            bottom: 0;
            z-index: 100;
            box-sizing: border-box;
        }

        /* 当侧边栏被折叠时的样式 */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* 主内容区域的样式设置，包括高度、布局和过渡效果 */
        .main-content {
            height: calc(100vh - 50px); /* 调整高度，留出顶部栏的高度 */
            display: flex;
            flex-direction: column;
            background-color: #343541;
            transition: margin-left 0.3s ease, width 0.3s ease;
            margin-left: 260px;
            width: calc(100% - 260px);
            margin-top: 50px; /* 留出顶部栏的空间 */
            overflow: hidden;
        }

        /* 当主内容区域扩展时的样式 */
        .main-content.expanded {
            margin-left: 0;
            width: 100%;
        }

        /* 新建对话按钮的样式，确保左对齐 */
        #new-chat-btn {
            margin-left: 10px; /* 调整左边距，与对话历史标题按钮对齐 */
            margin-right: 10px; /* 保持右边距与现有设置一致 */
            width: calc(100% - 20px); /* 设置按钮宽度，确保与左右边距一致 */
        }

        /* 聊天容器的样式设置，包括高度自动调整、滚动条样式和内边距 */
        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            height: 100%; /* 确保聊天区域最大化利用可用空间 */
            box-sizing: border-box;
        }

        /* 输入区域的样式设置，包括边框、内边距和布局方式 */
        .input-area {
            border-top: 1px solid #5c5c66;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        /* 输入行的样式设置，通常包含用户输入框和发送按钮 */
        .input-row {
            display: flex;
            margin-bottom: 10px;
        }

        /* 输入框和选择框的样式设置，包括内边距、边框和背景色 */
        input, select {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #5c5c66;
            background-color: #40414f;
            color: white;
            border-radius: 5px;
            box-sizing: border-box;
        }

        /* 按钮的基础样式设置，包括内边距、背景色、边框、圆角、外边距和光标样式 */
        button {
            padding: 10px 20px;
            background-color: #10a37f;
            color: white;
            border: none;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
        }

        /* 仅改变发送按钮的样式：固定宽度90px，高度40px */
        #send-btn {
            width: 90px;
            height: 40px;
            flex-shrink: 0;
        }

        /* 用户消息样式，包括背景色、字体颜色和边距 */
        .message {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
            position: relative;
            word-wrap: break-word; /* 确保长消息自动换行 */
            box-sizing: border-box;
        }
        .user-message {
            background-color: #444654;
            color: white;
        }

        /* AI消息样式，包括背景色和字体颜色 */
        .ai-message {
            background-color: #343541;
            color: white;
        }

        /* 聊天记录区域的样式设置，包括顶部外边距和自动调整滚动条样式 */
        .chat-history {
            margin-top: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        /* 聊天项目的样式设置，包括内边距、外边距、背景色、圆角和悬停效果 */
        .chat-item {
            padding: 10px;
            margin-bottom: 5px;
            background-color: #2d2d30;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
        }
        .chat-item:hover {
            background-color: #3d3d40;
        }

        /* 删除按钮和编辑按钮的基础样式设置，包括位置、背景色、边框、字体大小和悬停显示 */
        .delete-btn, .edit-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            border: none;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8em;
            display: none;
            cursor: pointer;
        }
        .delete-btn {
            background-color: #ff4d4d;
            color: white;
        }
        .edit-btn {
            background-color: #6e6e6e;
            color: white;
            right: 35px;
        }

        /* 当悬停在聊天项目或消息上时显示删除或编辑按钮 */
        .chat-item:hover .delete-btn,
        .message:hover .edit-btn {
            display: block;
        }

        /* 模态框的背景样式，覆盖整个屏幕 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        /* 模态框的内容样式，包括背景色、边距、圆角和阴影，设置固定尺寸 */
        .modal-content {
            background-color: #2d2d30;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            width: 350px; /* 固定宽度 */
            text-align: center;
        }

        /* 模态框标题的样式 */
        .modal-content h2 {
            margin-top: 0;
            color: white;
        }

        /* 模态框输入框的样式，设置固定宽度并居中 */
        .modal-content input {
            width: 90%; /* 宽度为模态框的 90% */
            padding: 10px;
            margin-top: 10px;
            background-color: #40414f;
            border: 1px solid #5c5c66;
            color: white;
            border-radius: 5px;
            box-sizing: border-box; /* 确保 padding 和 border 在总宽度内 */
        }

        /* 模态框按钮容器的样式，确保按钮水平排列并居中 */
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px; /* 按钮之间的间距 */
        }

        /* 模态框确认按钮和取消按钮的样式 */
        .modal-content button {
            padding: 10px 20px;
            background-color: #10a37f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .modal-content .cancel-btn {
            background-color: #6e6e6e;
        }

        /* 媒体查询：为移动设备进行优化 */
        @media (max-width: 768px) {
            .sidebar {
                width: 80vw; /* 调整侧边栏的宽度 */
                transform: translateX(-100%); /* 初始状态为隐藏 */
            }
            .sidebar.collapsed {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            .top-bar {
                height: 50px; /* 确保顶栏高度不变 */
            }
            .chat-container {
                height: calc(100vh - 50px); /* 适应屏幕高度 */
            }
            .input-area {
                padding: 10px;
            }
            .input-row {
                margin-bottom: 5px;
            }
            button {
                padding: 10px;
                font-size: 14px; /* 调整按钮字体大小 */
            }
        }
    </style>
    <!-- 引入加密库，用于生成哈希签名 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
</head>
<body>
    <!-- 顶部栏 -->
    <div class="top-bar">
        <div class="top-bar-content">
            <div class="top-bar-left">
                <h2 id="greeting"></h2>
                <button class="toggle-btn" id="toggle-btn" onclick="toggleSidebar()">⇐</button>
            </div>
            <div class="top-bar-right">
                <!-- 将来可以在这里添加更多按钮或菜单 -->
            </div>
        </div>
    </div>

    <!-- 侧边栏，包括聊天历史 -->
    <div class="sidebar" id="sidebar">
        <button id="new-chat-btn" onclick="openModal()">新建对话</button>
        <div class="chat-history" id="chatHistory"></div>
    </div>
    
    <!-- 主内容区域，包括聊天容器和输入区域 -->
    <div class="main-content" id="mainContent">
        <div class="chat-container" id="chatContainer"></div>
        <div class="input-area" id="inputArea">
            <!-- 模型选择下拉框 -->
            <div class="input-row" id="inputRowModelSelect">
                <select id="modelSelect">
                    <option value="deepseek">DeepSeek</option>
                    <option value="gpt-3.5-turbo">ChatGPT (gpt-3.5-turbo)</option>
                    <option value="gpt-4o-mini-2024-07-18">ChatGPT (gpt-4o-mini)</option>
                    <option value="tiangong">天工 Sky-Chat-3.0</option>
                </select>
            </div>
            <!-- 用户输入和发送按钮 -->
            <div class="input-row" id="inputRowUserInput">
                <input type="text" id="userInput" placeholder="输入您的消息...">
                <button id="send-btn" onclick="sendMessage()">发送</button>
            </div>
        </div>
    </div>

    <!-- 模态框结构 -->
    <div class="modal-overlay" id="modalOverlay" style="display: none;">
        <div class="modal-content">
            <h2>请输入新对话的标题：</h2>
            <input type="text" id="chatNameInput" placeholder="对话标题">
            <div class="modal-buttons">
                <button onclick="newChat()">确认</button>
                <button class="cancel-btn" onclick="closeModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- JavaScript功能脚本 -->
    <script>
        function adjustHeight() {
            // 获取视口的高度，并减去顶部栏的高度（50px）
            const viewportHeight = window.innerHeight;
            const topBarHeight = document.querySelector('.top-bar').offsetHeight;
            const availableHeight = viewportHeight - topBarHeight;

            // 调整主内容区域和聊天容器的高度
            document.querySelector('.main-content').style.height = availableHeight + 'px';
            document.querySelector('.chat-container').style.height = availableHeight - topBarHeight + 'px'; // 留出输入区域的空间
        }

        // 初始调用一次
        adjustHeight();

        // 监听窗口大小变化事件
        window.addEventListener('resize', adjustHeight);

        let currentChatId = Date.now(); // 当前对话的唯一ID
        let chats = JSON.parse(localStorage.getItem('chats')) || {}; // 加载本地存储中的对话记录
        let isEditing = false; // 编辑状态标志

        // 模型API映射表，包含API密钥和URL等信息
        const modelAPIMapping = {
            "deepseek": {
                apiKey: "sk-92c88102bc1d432e99b3523e0dd2a169",
                apiUrl: "https://api.deepseek.com/chat/completions",
                model: "deepseek-chat"
            },
            "gpt-3.5-turbo": {
                apiKey: "sk-proj-HsBHBt7QNY6pfVU6k4GNT3BlbkFJRZ213DySpXQbnUxXqxyy",
                apiUrl: "https://api.openai.com/v1/chat/completions",
                model: "gpt-3.5-turbo-0125"
            },
            "gpt-4o-mini-2024-07-18": {
                apiKey: "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",
                apiUrl: "https://api.openai.com/v1/chat/completions",
                model: "gpt-4o-mini-2024-07-18"
            },
            "tiangong": {
                appKey: "7641ba4a0e09f0cc690552052859bcee",
                appSecret: "802522e124112e9b526194e857f29adb59756198462e4728",
                apiUrl: "https://api-maas.singularity-ai.com/sky-work/api/v1/chat"
            }
        };

        let currentModel = "deepseek"; // 当前选中的AI模型

        // 模型选择下拉框事件监听，更新当前模型
        document.getElementById('modelSelect').addEventListener('change', function(event) {
            currentModel = event.target.value;
        });

        // 切换侧边栏显示/隐藏状态
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');

            // 根据侧边栏状态更新按钮内容
            const toggleBtn = document.getElementById('toggle-btn');
            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.textContent = "⇒";
            } else {
                toggleBtn.textContent = "⇐";
            }
        }

        // 打开模态框
        function openModal() {
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        // 新建聊天对话
        function newChat() {
            const chatName = document.getElementById('chatNameInput').value.trim();
            if (chatName) {
                currentChatId = Date.now();
                chats[currentChatId] = [];
                chats[currentChatId].push({ user: chatName, ai: "" }); // 保存聊天对话名称
                document.getElementById('chatContainer').innerHTML = '';
                conversation = [
                    { role: "system", content: "The following is a conversation with an AI assistant. The assistant is helpful, creative, clever, and very friendly." }
                ];
                saveChatHistory();
                updateChatHistory();
                closeModal();
            }
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        // 发送用户消息并获取AI回复
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const chatContainer = document.getElementById('chatContainer');
            
            if (userInput.value.trim() !== '') {
                const userMessage = document.createElement('div');
                userMessage.className = 'message user-message';
                userMessage.textContent = userInput.value;
                addEditButton(userMessage);
                chatContainer.appendChild(userMessage);

                conversation.push({ role: "user", content: userInput.value });

                userInput.value = '';

                getAIResponse();
            }
        }

        // 调用AI接口获取AI回复
        async function getAIResponse() {
            try {
                const modelConfig = modelAPIMapping[currentModel];
                let response;

                if (currentModel === "tiangong") {
                    const timestamp = Math.floor(Date.now() / 1000).toString();
                    const sign = md5(modelConfig.appKey + modelConfig.appSecret + timestamp);

                    const headers = {
                        'app_key': modelConfig.appKey,
                        'timestamp': timestamp,
                        'sign': sign,
                        'Content-Type': 'application/json'
                    };

                    const body = JSON.stringify({
                        messages: conversation,
                        intent: ""
                    });

                    response = await fetch(modelConfig.apiUrl, {
                        method: 'POST',
                        headers: headers,
                        body: body
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let aiMessage = "";

                    const aiMessageElement = document.createElement('div');
                    aiMessageElement.className = 'message ai-message';
                    document.getElementById('chatContainer').appendChild(aiMessageElement);

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (let line of lines) {
                            if (line.startsWith('data: ')) {
                                line = line.replace(/^data: /, '').trim();
                                if (line === '[DONE]') {
                                    return aiMessage;
                                }
                                if (line) {
                                    try {
                                        const json = JSON.parse(line);
                                        if (json.arguments && json.arguments[0].messages[0].text) {
                                            aiMessage += json.arguments[0].messages[0].text.trim();
                                            aiMessageElement.textContent = aiMessage;
                                        }
                                    } catch (e) {
                                        console.error('JSON parse error:', e);
                                    }
                                }
                            }
                        }
                    }
                } else {
                    response = await fetch(modelConfig.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${modelConfig.apiKey}`
                        },
                        body: JSON.stringify({
                            model: modelConfig.model,
                            messages: conversation,
                            stream: true
                        })
                    });

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let aiMessage = "";

                    const aiMessageElement = document.createElement('div');
                    aiMessageElement.className = 'message ai-message';
                    document.getElementById('chatContainer').appendChild(aiMessageElement);

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');

                        for (let line of lines) {
                            if (line.startsWith('data: ')) {
                                line = line.replace(/^data: /, '').trim();
                                if (line === '[DONE]') {
                                    return aiMessage;
                                }
                                if (line) {
                                    try {
                                        const json = JSON.parse(line);
                                        if (json.choices && json.choices[0].delta && json.choices[0].delta.content) {
                                            aiMessage += json.choices[0].delta.content.trim();
                                            aiMessageElement.textContent = aiMessage;
                                        }
                                    } catch (e) {
                                        console.error('JSON parse error:', e);
                                    }
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                return '对不起，我无法处理你的请求。';
            }
        }

        // 添加编辑按钮到消息元素
        function addEditButton(messageElement) {
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn';
            editBtn.textContent = '编辑';
            editBtn.onclick = () => editMessage(messageElement);
            messageElement.appendChild(editBtn);
        }

        // 编辑用户消息
        function editMessage(messageElement) {
            if (isEditing) return;
            isEditing = true;

            const originalText = messageElement.textContent.replace('编辑', '').trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalText;
            input.style.width = '100%';

            messageElement.textContent = '';
            messageElement.appendChild(input);
            input.focus();

            input.onblur = () => {
                messageElement.textContent = input.value;
                addEditButton(messageElement);
                isEditing = false;
                saveChatHistory();
                resendEditedMessage(input.value);
            };

            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
        }

        // 重新发送编辑后的消息
        function resendEditedMessage(editedMessage) {
            conversation[conversation.length - 1].content = editedMessage; // 修改最后一条用户消息
            const chatContainer = document.getElementById('chatContainer');
            const messages = chatContainer.querySelectorAll('.message');
            messages[messages.length - 1].remove(); // 移除旧的AI回复

            getAIResponse().then(aiMessage => {
                const aiMessageElement = document.createElement('div');
                aiMessageElement.className = 'message ai-message';
                aiMessageElement.textContent = aiMessage;
                chatContainer.appendChild(aiMessageElement);

                chatContainer.scrollTop = chatContainer.scrollHeight;

                chats[currentChatId][chats[currentChatId].length - 1].ai = aiMessageElement.textContent; // 更新AI回复
                saveChatHistory();
                updateChatHistory();
            });
        }

        // 更新聊天历史显示
        function updateChatHistory() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = '';
            Object.keys(chats).forEach(chatId => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.textContent = chats[chatId][0].user.substring(0, 20);
                chatItem.onclick = () => loadChat(chatId);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = '删除';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteChat(chatId);
                };
                
                chatItem.appendChild(deleteBtn);
                chatHistory.appendChild(chatItem);
            });
        }

        // 加载指定聊天历史
        function loadChat(chatId) {
            currentChatId = chatId;
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            conversation = [
                { role: "system", content: "The following is a conversation with an AI assistant. The assistant is helpful, creative, clever, and very friendly." }
            ];
            chats[chatId].forEach(message => {
                const userMessage = document.createElement('div');
                userMessage.className = 'message user-message';
                userMessage.textContent = message.user;
                addEditButton(userMessage);
                chatContainer.appendChild(userMessage);

                conversation.push({ role: "user", content: message.user });

                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai-message';
                aiMessage.textContent = message.ai;
                chatContainer.appendChild(aiMessage);

                conversation.push({ role: "assistant", content: message.ai });
            });
        }

        // 删除指定聊天历史
        function deleteChat(chatId) {
            delete chats[chatId];
            saveChatHistory();
            updateChatHistory();
            if (currentChatId === chatId) {
                newChat();
            }
        }

        // 保存聊天历史到本地存储
        function saveChatHistory() {
            localStorage.setItem('chats', JSON.stringify(chats));
        }

        // 添加事件监听器，支持按下回车键发送消息
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // MD5哈希函数，用于生成签名
        const md5 = (string) => CryptoJS.MD5(string).toString();

        // 初始化对话内容
        let conversation = [
            { role: "system", content: "The following is a conversation with an AI assistant. The assistant is helpful, creative, clever, and very friendly." }
        ];

        // 页面加载时更新聊天历史
        window.addEventListener('load', updateChatHistory);

        // 根据时间生成问候语
        function getGreeting() {
            const now = new Date();
            const hour = now.getHours();
            if (hour < 6) {
                return "凌晨好";
            } else if (hour < 9) {
                return "早上好";
            } else if (hour < 12) {
                return "上午好";
            } else if (hour < 14) {
                return "中午好";
            } else if (hour < 18) {
                return "下午好";
            } else {
                return "晚上好";
            }
        }

        // 打字效果显示问候语
        function typeGreeting() {
            const greetingElement = document.getElementById('greeting');
            const greeting = getGreeting();
            let index = 0;

            function type() {
                if (index < greeting.length) {
                    greetingElement.textContent += greeting[index];
                    index++;
                    setTimeout(type, 200); // 控制打字速度
                } else {
                    setTimeout(() => {
                        greetingElement.style.borderRight = 'none'; // 打字结束后移除光标
                    }, 500);
                }
            }

            greetingElement.textContent = '';
            greetingElement.style.borderRight = '3px solid white';
            type();
        }

        // 页面加载或重新聚焦时触发打字效果
        window.addEventListener('load', typeGreeting);
        window.addEventListener('focus', typeGreeting);

    </script>
</body>
</html>
